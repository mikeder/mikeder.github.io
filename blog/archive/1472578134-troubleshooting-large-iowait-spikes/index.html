<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Troubleshooting large IOWait spikes</title>
     
    <link rel="stylesheet" href='/css/style.css'> 
    <script src="https://kit.fontawesome.com/9ebc75ba92.js" crossorigin="anonymous"></script>
</head>

<body>
    <header id="site-header">
    <div class="nav">
        <a href="https://mikeder.net/">Home</a>  
        <a href="/about/">Abouts</a> 
        <a href="/blog/">Blogs</a> 
        <a href="/projects/">Projects</a> 
        <a href="/synthesizers/">Synthesizers</a>  
    </div>
</header> 
<main id="content" class="content">
    <article class="content-chunk">
        <h1>Troubleshooting large IOWait spikes</h1>
        <h5>30.08.2016 17:28</h5>
        <div class="container">
            <p>changed mount options:</p>
<ul>
<li>Before: defaults,noatime,nodiratime,barrier=1,data=ordered,errors=remount-ro</li>
<li>After: relatime,barrier=0,errors=remount-ro</li>
</ul>
<p>pveperf before:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@pve-01:~# pveperf /
CPU BOGOMIPS:      19244.00
REGEX/SECOND:      <span style="color:#ae81ff">959888</span>
HD SIZE:           27.19 GB <span style="color:#f92672">(</span>/dev/dm-0<span style="color:#f92672">)</span>
BUFFERED READS:    195.02 MB/sec
AVERAGE SEEK TIME: 0.26 ms
FSYNCS/SECOND:     301.31
DNS EXT:           93.93 ms
DNS INT:           93.76 ms <span style="color:#f92672">(</span>sqweeb.net<span style="color:#f92672">)</span>

root@pve-01:~# pveperf /var/lib/vz
CPU BOGOMIPS:      19244.00
REGEX/SECOND:      <span style="color:#ae81ff">978722</span>
HD SIZE:           178.85 GB <span style="color:#f92672">(</span>/dev/mapper/pve-data<span style="color:#f92672">)</span>
BUFFERED READS:    197.73 MB/sec
AVERAGE SEEK TIME: 0.20 ms
FSYNCS/SECOND:     316.08
DNS EXT:           84.80 ms
DNS INT:           107.74 ms <span style="color:#f92672">(</span>sqweeb.net<span style="color:#f92672">)</span>

</code></pre></div><p>pveperf after:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@pve-01:~# pveperf /
CPU BOGOMIPS:      19244.08
REGEX/SECOND:      <span style="color:#ae81ff">953290</span>
HD SIZE:           27.19 GB <span style="color:#f92672">(</span>/dev/dm-0<span style="color:#f92672">)</span>
BUFFERED READS:    176.81 MB/sec
AVERAGE SEEK TIME: 0.26 ms
FSYNCS/SECOND:     2128.05
DNS EXT:           113.88 ms
DNS INT:           106.68 ms <span style="color:#f92672">(</span>sqweeb.net<span style="color:#f92672">)</span>

root@pve-01:~# pveperf /var/lib/vz
CPU BOGOMIPS:      19244.08
REGEX/SECOND:      <span style="color:#ae81ff">980483</span>
HD SIZE:           178.85 GB <span style="color:#f92672">(</span>/dev/mapper/pve-data<span style="color:#f92672">)</span>
BUFFERED READS:    194.57 MB/sec
AVERAGE SEEK TIME: 0.20 ms
FSYNCS/SECOND:     2376.09
DNS EXT:           104.70 ms
DNS INT:           90.75 ms <span style="color:#f92672">(</span>sqweeb.net<span style="color:#f92672">)</span>
</code></pre></div><p>I also found there were some rouge monitoring processes running after a host reboot, collectd, splunkd, and filebeat were all running from previous installs. I hunted down and removed/stopped/deleted all associated files I could find on the host and the containers.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">find / -name <span style="color:#e6db74">&#39;splunk&#39;</span>
find / -name <span style="color:#e6db74">&#39;collectd&#39;</span>
find/ -name <span style="color:#e6db74">&#39;filebeat&#39;</span>
</code></pre></div><p>After these changes I found that the IOWait spikes were still occurring at ~15-20min intervals. Doing some more digging I found something interesting, it seems that the /dev/sda device is the source of delay, and when checking smartctl I found that the firmware is different on this drive compared to a drive of the same model:</p>
<h4 id="devsda">/dev/sda</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@pve-01:~# smartctl -a /dev/sda
smartctl 6.4 2014-10-07 r4002 <span style="color:#f92672">[</span>x86_64-linux-4.2.6-1-pve<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>local build<span style="color:#f92672">)</span>
Copyright <span style="color:#f92672">(</span>C<span style="color:#f92672">)</span> 2002-14, Bruce Allen, Christian Franke, www.smartmontools.org

<span style="color:#f92672">===</span> START OF INFORMATION SECTION <span style="color:#f92672">===</span>
Device Model:     SanDisk SDSSDA120G
Serial Number:    <span style="color:#ae81ff">154414402842</span>
LU WWN Device Id: <span style="color:#ae81ff">5</span> 001b44 eff65c91a
Firmware Version: Z22000RL
User Capacity:    120,034,123,776 bytes <span style="color:#f92672">[</span><span style="color:#ae81ff">120</span> GB<span style="color:#f92672">]</span>
Sector Size:      <span style="color:#ae81ff">512</span> bytes logical/physical
Rotation Rate:    Solid State Device
Form Factor:      1.8 inches
Device is:        Not in smartctl database <span style="color:#f92672">[</span><span style="color:#66d9ef">for</span> details use: -P showall<span style="color:#f92672">]</span>
ATA Version is:   ACS-2 T13/2015-D revision <span style="color:#ae81ff">3</span>
SATA Version is:  SATA 3.2, 6.0 Gb/s <span style="color:#f92672">(</span>current: 3.0 Gb/s<span style="color:#f92672">)</span>
Local Time is:    Wed Aug <span style="color:#ae81ff">31</span> 10:17:57 <span style="color:#ae81ff">2016</span> EDT
SMART support is: Available - device has SMART capability.
SMART support is: Enabled
</code></pre></div><h4 id="devsdc">/dev/sdc</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@pve-01:~# smartctl -a /dev/sdc
smartctl 6.4 2014-10-07 r4002 <span style="color:#f92672">[</span>x86_64-linux-4.2.6-1-pve<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>local build<span style="color:#f92672">)</span>
Copyright <span style="color:#f92672">(</span>C<span style="color:#f92672">)</span> 2002-14, Bruce Allen, Christian Franke, www.smartmontools.org

<span style="color:#f92672">===</span> START OF INFORMATION SECTION <span style="color:#f92672">===</span>
Device Model:     SanDisk SDSSDA120G
Serial Number:    <span style="color:#ae81ff">154400408149</span>
LU WWN Device Id: <span style="color:#ae81ff">5</span> 001b44 efe903e55
Firmware Version: U21010RL
User Capacity:    120,034,123,776 bytes <span style="color:#f92672">[</span><span style="color:#ae81ff">120</span> GB<span style="color:#f92672">]</span>
Sector Size:      <span style="color:#ae81ff">512</span> bytes logical/physical
Rotation Rate:    Solid State Device
Form Factor:      2.5 inches
Device is:        Not in smartctl database <span style="color:#f92672">[</span><span style="color:#66d9ef">for</span> details use: -P showall<span style="color:#f92672">]</span>
ATA Version is:   ACS-2 T13/2015-D revision <span style="color:#ae81ff">3</span>
SATA Version is:  SATA 3.2, 6.0 Gb/s <span style="color:#f92672">(</span>current: 3.0 Gb/s<span style="color:#f92672">)</span>
Local Time is:    Wed Aug <span style="color:#ae81ff">31</span> 10:22:50 <span style="color:#ae81ff">2016</span> EDT
SMART support is: Available - device has SMART capability.
SMART support is: Enabled
</code></pre></div><p>At this time it isn&rsquo;t clear if it is even possible to update or change the firmware on these drives..</p>
<p>Also look into further fstab tweaks:
<a href="http://www.howtogeek.com/62761/how-to-tweak-your-ssd-in-ubuntu-for-better-performance/">http://www.howtogeek.com/62761/how-to-tweak-your-ssd-in-ubuntu-for-better-performance/</a></p>
<h1 id="update-9116---1035am">Update 9/1/16 - 10:35AM</h1>
<p>After looking back over the above documents, mount option tweaks for SSD&rsquo;s and such I realized I was overlooking one important task; fstrim. Most posts discussed enabling the discard mount option for SSD&rsquo;s but then other posts suggested this option causes a huge decrease in performance and to instead create a cron job that runs fstrim daily or weekly. I enabled a daily TRIM using the following script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/etc/cron.daily/fstrim

<span style="color:#75715e">#!/bin/sh</span>

PATH<span style="color:#f92672">=</span>/bin:/sbin:/usr/bin:/usr/sbin

ionice -n <span style="color:#ae81ff">7</span> fstrim -v /
ionice -n <span style="color:#ae81ff">7</span> fstrim -v /var/lib/vz

</code></pre></div><p>I then manually ran the two commands to apply the trim job now and there was an immediate improvement. I am no longer seeing 15-20% spikes in IOWAIT every 20-30 minutes!!</p>

        </div>
         
        <div>
            <a href="javascript:history.back()">Go Back</a>
        </div>
    </article>
</main>
 




<div id="myModal" class="modal">
    <div class="modal-content">
        <img class="modal-pic" id="modalPic" onclick="closeModal()" style="max-width: 100%; max-height: 80vh; margin: auto;">
    </div>
    <button class="modal-close" onclick="closeModal()">X</button>
</div>

<script>
    
    function openModal(clicked_id) {
        var src = document.getElementById(clicked_id).src;
        if (src.includes("#")) {
            src = src.substring(0, src.indexOf("#"));
        };
        document.getElementById("modalPic").src = src;
        document.getElementById("myModal").style.display = "block";
        
        
        document.getElementById("site-header").style.display = "none";
        document.getElementById("content").style.display = "none";
        document.getElementById("site-footer").style.display = "none";
    }

    
    function closeModal() {
        
        document.getElementById("modalPic").src = "";
        document.getElementById("myModal").style.display = "none";
        
        document.getElementById("site-header").style.display = "block";
        document.getElementById("content").style.display = "block";
        document.getElementById("site-footer").style.display = "block";
    }
    closeModal()
</script>    

<footer id="site-footer">
    <p>
        &copy; 2022 <a href="https://mikeder.net/">mikeder.net</a> v:7ba9364</p>

    
    <a class="fab fa-bandcamp" style="font-size: 24px" href="https://bandcamp.com/mikeder" target="_blank"></a>
     
    <a class="fab fa-github" style="font-size: 24px" href="https://github.com/mikeder" target="_blank"></a>
     
    <a class="fab fa-instagram" style="font-size: 24px" href="https://www.instagram.com/sqweebking/" target="_blank"></a>
     
    <a class="fab fa-soundcloud" style="font-size: 24px" href="https://soundcloud.com/sqweebking" target="_blank"></a>
     
    <a class="fab fa-youtube" style="font-size: 24px" href="https://www.youtube.com/user/synthatik" target="_blank"></a>
    
</footer>
</body>

</html>