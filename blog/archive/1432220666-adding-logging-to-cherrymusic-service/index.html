<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Adding logging to CherryMusic service</title>
    
    <meta name="description" content="A static site built with Hugo!">
    
    
    <meta name="author" content="Mike Eder">
    

    
    <link rel="me" href="https://universeodon.com/@sqweebking">
    

    <link rel="stylesheet" href='/css/style.css'> 
    <script src="https://kit.fontawesome.com/9ebc75ba92.js" crossorigin="anonymous"></script>
</head>

<body>
    <header id="site-header">
    <div class="nav">
        <a href="https://mikeder.net/">Home</a>  
        <a href="/about/">Abouts</a> 
        <a href="/blog/">Blogs</a> 
        <a href="/projects/">Projects</a> 
        <a href="/synthesizers/">Synthesizers</a>  
    </div>
</header> 
<main id="content" class="content">
    <article class="content-chunk">
        <h1>Adding logging to CherryMusic service</h1>
        <h5>21.05.2015 15:04</h5>
        <div class="container">
            <p>This morning I added some logging functionality to the <!-- raw HTML omitted -->cherrymusic service script<!-- raw HTML omitted --> that lives in /etc/init.d/cherrymusic. I have a couple issues going on with the music server that are going to require some log digging. One of which I&rsquo;ve already fixed: Some of the Web Rips sub directories would open up empty. Upon review the logs when accessing those folders I found this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>150521-14:10<span style="color:#f92672">]</span> ERROR   : <span style="color:#f92672">[</span>21/May/2015:14:10:41<span style="color:#f92672">]</span> HTTP Traceback <span style="color:#f92672">(</span>most recent call last<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/home/cherrymusic/cherrymusic-devel/cherrypy/_cprequest.py&#34;</span>, line 656, in respond
</span></span><span style="display:flex;"><span>    response.body <span style="color:#f92672">=</span> self.handler<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/home/cherrymusic/cherrymusic-devel/cherrypy/lib/encoding.py&#34;</span>, line 188, in __call__
</span></span><span style="display:flex;"><span>    self.body <span style="color:#f92672">=</span> self.oldhandler<span style="color:#f92672">(</span>*args, **kwargs<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/home/cherrymusic/cherrymusic-devel/cherrypy/_cpdispatch.py&#34;</span>, line 34, in __call__
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> self.callable<span style="color:#f92672">(</span>*self.args, **self.kwargs<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/home/cherrymusic/cherrymusic-devel/cherrymusicserver/httphandler.py&#34;</span>, line 291, in api
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> json.dumps<span style="color:#f92672">({</span><span style="color:#e6db74">&#39;data&#39;</span>: handler<span style="color:#f92672">(</span>**handler_args<span style="color:#f92672">)})</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/home/cherrymusic/cherrymusic-devel/cherrymusicserver/httphandler.py&#34;</span>, line 471, in api_compactlistdir
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">[</span>entry.to_dict<span style="color:#f92672">()</span> <span style="color:#66d9ef">for</span> entry in files_to_list<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/home/cherrymusic/cherrymusic-devel/cherrymusicserver/httphandler.py&#34;</span>, line 471, in &lt;listcomp&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">[</span>entry.to_dict<span style="color:#f92672">()</span> <span style="color:#66d9ef">for</span> entry in files_to_list<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/home/cherrymusic/cherrymusic-devel/cherrymusicserver/cherrymodel.py&#34;</span>, line 401, in to_dict
</span></span><span style="display:flex;"><span>    urlpath <span style="color:#f92672">=</span> quote<span style="color:#f92672">(</span>self.path.encode<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;utf8&#39;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>UnicodeEncodeError: <span style="color:#e6db74">&#39;utf-8&#39;</span> codec can<span style="color:#e6db74">&#39;t encode character &#39;</span><span style="color:#ae81ff">\u</span>dce2<span style="color:#960050;background-color:#1e0010">&#39;</span> in position 29: surrogates not allowed
</span></span></code></pre></div><p>This is obviously because my filename sanitizing in the music-scraper script I use is lacking. So I found a decent bash script for renaming filenames that contain invalid characters.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>find <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> -depth -print0 | <span style="color:#66d9ef">while</span> IFS<span style="color:#f92672">=</span> read -r -d <span style="color:#e6db74">&#39;&#39;</span> file; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  d<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span> dirname <span style="color:#e6db74">&#34;</span>$file<span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  f<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span> basename <span style="color:#e6db74">&#34;</span>$file<span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  new<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>f//[^a-zA-Z0-9<span style="color:#ae81ff">\/\.</span> <span style="color:#ae81ff">\&amp;</span>_()<span style="color:#ae81ff">\-</span>]/<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$f<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span>$new<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>      <span style="color:#75715e"># if equal, name is already clean, so leave alone</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -e <span style="color:#e6db74">&#34;</span>$d<span style="color:#e6db74">/</span>$new<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>      echo <span style="color:#e6db74">&#34;Notice: \&#34;</span>$new<span style="color:#e6db74">\&#34; and \&#34;</span>$f<span style="color:#e6db74">\&#34; both exist in &#34;</span>$d<span style="color:#e6db74">&#34;:&#34;</span>
</span></span><span style="display:flex;"><span>      ls -ld <span style="color:#e6db74">&#34;</span>$d<span style="color:#e6db74">/</span>$new<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$d<span style="color:#e6db74">/</span>$f<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      echo mv <span style="color:#e6db74">&#34;</span>$file<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$d<span style="color:#e6db74">/</span>$new<span style="color:#e6db74">&#34;</span>      <span style="color:#75715e"># remove &#34;echo&#34; to actually rename things</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>I saved this script in /home/cherrymusic so I can run it if I start to see this issue again but ideally I&rsquo;d like to fix the music-scraper script so it doesn&rsquo;t allow these characters through in the first place.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Dump all filenames to be changed into a text file to be reviewed</span>
</span></span><span style="display:flex;"><span>cherrymusic@cherrym-ct:~$ ./rename.sh /mnt/vm-storage-1/Music/Web<span style="color:#ae81ff">\ </span>Rips &gt; rename.txt
</span></span></code></pre></div><p>Once everything was looking good in the test run dump into replace.txt I removed the &ldquo;echo&rdquo; from the mv command in the rename script and ran it again to actually perform the renaming.</p>
<p>Finally I added a cron job to be run daily to rotate the cherrymusic log files so they don&rsquo;t get too huge. I still need to add another line to remove logs older than a week or so, but that can wait a bit.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># m h  dom mon dow   command</span>
</span></span><span style="display:flex;"><span>@daily /home/cherrymusic/logrotate.sh
</span></span></code></pre></div>
        </div>
        
        <div>
            Tags:
            
            <a href=/tags/archive>archive</a>
            
        </div>
         
        <br>
        <div>
            <a href="javascript:history.back()">
                &lt;&lt; Back</a>
                    <a href="#top">Top ^^</a>
        </div>
    </article>
</main>
 




<div id="myModal" class="modal">
    <div class="modal-content">
        <img class="modal-pic" id="modalPic" onclick="closeModal()"
            style="max-width: 100%; max-height: 80vh; margin: auto;">
    </div>
    <button class="modal-close" onclick="closeModal()">X</button>
</div>

<script>
    
    function openModal(clicked_id) {
        var src = document.getElementById(clicked_id).src;
        if (src.includes("#")) {
            src = src.substring(0, src.indexOf("#"));
        };
        document.getElementById("modalPic").src = src;
        document.getElementById("myModal").style.display = "block";
        
        
        document.getElementById("site-header").style.display = "none";
        document.getElementById("content").style.display = "none";
        document.getElementById("site-footer").style.display = "none";
    }

    
    function closeModal() {
        
        document.getElementById("modalPic").src = "";
        document.getElementById("myModal").style.display = "none";
        
        document.getElementById("site-header").style.display = "block";
        document.getElementById("content").style.display = "block";
        document.getElementById("site-footer").style.display = "block";
    }
    closeModal()
</script>    

<footer id="site-footer">
    <p>
        &copy; 2025 <a href="https://mikeder.net/">mikeder.net</a> v:6cc2fda</p>

    
    <a class="fab fa-bandcamp" style="font-size: 24px" href="https://bandcamp.com/mikeder" target="_blank"></a>
     
    <a class="fab fa-docker" style="font-size: 24px" href="https://hub.docker.com/u/mikeder" target="_blank"></a>
     
    <a class="fab fa-github" rel="me" style="font-size: 24px" href="https://github.com/mikeder" target="_blank"></a>
     
    <a class="fab fa-instagram" style="font-size: 24px" href="https://www.instagram.com/sqweebking/" target="_blank"></a>
     
    <a class="fab fa-mastodon" style="font-size: 24px" href="https://universeodon.com/@sqweebking" target="_blank"></a>
     
    <a class="fab fa-soundcloud" style="font-size: 24px" href="https://soundcloud.com/sqweebking" target="_blank"></a>
     
    <a class="fab fa-youtube" style="font-size: 24px" href="https://www.youtube.com/user/synthatik" target="_blank"></a>
    
</footer>
</body>

</html>