<!DOCTYPE html>
<html lang="en-us">

<head>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LJHGWQB579"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-LJHGWQB579');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Replacing squid3 w/ nginx</title>
    
    <meta name="description" content="A static site built with Hugo!">
    
    
    <meta name="author" content="Mike Eder">
    

    
    <link rel="me" href="https://universeodon.com/@sqweebking">
    

    <link rel="stylesheet" href='/css/style.css'> 
    <script src="https://kit.fontawesome.com/9ebc75ba92.js" crossorigin="anonymous"></script>
</head>

<body>
    <header id="site-header">
    <div class="nav">
        <a href="https://mikeder.net/">Home</a>  
        <a href="/about/">Abouts</a> 
        <a href="/blog/">Blogs</a> 
        <a href="/projects/">Projects</a> 
        <a href="/synthesizers/">Synthesizers</a>  
    </div>
</header> 
<main id="content" class="content">
    <article class="content-chunk">
        <h1>Replacing squid3 w/ nginx</h1>
        <h5>28.06.2015 12:43</h5>
        <div class="container">
            <p>When I was using the squid3 package in pfSense it came configured ready to use SSL and you could just import your cert&rsquo;s or let it generate one for you and it just worked. Then I decided to swap out pfSense for a basic squid3 proxy, which at first was great. Configuration was super simple and I had it up and running in a matter of minutes, for most of my backend anyway. I quickly realized that squid3 did not come compiled with SSL support and this meant I couldn&rsquo;t proxy to servers running on HTTPS (airtime, proxmox, etc). No problem, there is plenty of documentation out there on how to recompile with SSL support and where to put certs and all that. Problem was, I couldn&rsquo;t for the life of me get it to work. I would compile and recompile and squid would never end up with SSL support.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@proxy:~# squid3 -v | grep ssl                                                          
</span></span><span style="display:flex;"><span>root@proxy:~# 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Nothing?!</span>
</span></span></code></pre></div><p>So I set out to find another option, I knew that nginx could perform reverse proxy functions but at first look it looked more complicated than squid. Having another look it didn&rsquo;t seem so bad, and I was bored at work tonight, so I figured I&rsquo;d give it a shot. I set up a fresh Debian 7 container and went through the normal procedure of setting up DHCP, reserving the address on the router and updating packages. I roughly followed <!-- raw HTML omitted -->this tutorial<!-- raw HTML omitted --> to get nginx installed and a new SSL cert in place.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@proxy:~# apt-get install nginx
</span></span><span style="display:flex;"><span>root@proxy:~# cd /etc/nginx
</span></span><span style="display:flex;"><span>root@proxy:~# sudo openssl req -x509 -nodes -days <span style="color:#ae81ff">365</span> -newkey rsa:2048 -keyout /etc/nginx/cert.key -out /etc/nginx/cert.crt
</span></span></code></pre></div><p>Once nginx was installed it was just a matter of creating a new site file in /etc/nginx/sites-availalable with my configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># /etc/nginx/sites-available/sqweebnet</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Reverse proxy settings</span>
</span></span><span style="display:flex;"><span>proxy_redirect off;
</span></span><span style="display:flex;"><span>proxy_set_header Host $host;
</span></span><span style="display:flex;"><span>proxy_set_header X-Real-IP $remote_addr;
</span></span><span style="display:flex;"><span>proxy_set_header X-Forwarded-For $remote_addr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## List upstream servers ##</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Airtme server</span>
</span></span><span style="display:flex;"><span>upstream airtime <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    server airtime.sqweeb.net:443;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Blog server</span>
</span></span><span style="display:flex;"><span>upstream blog <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    server blog.sqweeb.net:8888;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CherryMusic server</span>
</span></span><span style="display:flex;"><span>upstream cherrym <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    server cherrym.sqweeb.net:8080;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DHT sensor</span>
</span></span><span style="display:flex;"><span>upstream dht <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    server dht.sqweeb.net;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GitLab server</span>
</span></span><span style="display:flex;"><span>upstream gitlab <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    server git.sqweeb.net;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>                                                                                                                                                                                                                                 <span style="color:#75715e"># Begin server definitions #</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    listen <span style="color:#ae81ff">443</span> ssl;
</span></span><span style="display:flex;"><span>    server_name airtime.sqweeb.net;
</span></span><span style="display:flex;"><span>    ssl_certificate /etc/nginx/cert.crt;
</span></span><span style="display:flex;"><span>    ssl_certificate_key /etc/nginx/cert.key;
</span></span><span style="display:flex;"><span>    ssl on;
</span></span><span style="display:flex;"><span>    ssl_session_cache builtin:1000 shared:SSL:10m;
</span></span><span style="display:flex;"><span>    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
</span></span><span style="display:flex;"><span>    ssl_ciphers HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;
</span></span><span style="display:flex;"><span>    ssl_prefer_server_ciphers on;
</span></span><span style="display:flex;"><span>    location / <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        proxy_ssl_session_reuse off;
</span></span><span style="display:flex;"><span>        proxy_set_header X-Forwarded-Proto $scheme;
</span></span><span style="display:flex;"><span>        proxy_pass https://airtime;
</span></span><span style="display:flex;"><span>        proxy_read_timeout 90;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    listen 80;
</span></span><span style="display:flex;"><span>    server_name www.sqweeb.net;
</span></span><span style="display:flex;"><span>    location / <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        proxy_pass http://blog;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    listen 80;
</span></span><span style="display:flex;"><span>    server_name git.sqweeb.net;
</span></span><span style="display:flex;"><span>    location / <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        proxy_pass http://git;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    listen 80;
</span></span><span style="display:flex;"><span>    server_name cherry.sqweeb.net;
</span></span><span style="display:flex;"><span>    location / <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        proxy_pass http://cherrym;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    listen 80;
</span></span><span style="display:flex;"><span>    server_name dht.sqweeb.net;
</span></span><span style="display:flex;"><span>    location / <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        proxy_pass http://dht;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>            
</span></span></code></pre></div><p>After the config is in place I just make a symbolic link to the /sites-enabled folder and restart nginx.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@nginx-proxy:~# ln -s /etc/nginx/sites-available/sqweebnet /etc/nginx/sites-enabled/sqweebnet
</span></span><span style="display:flex;"><span>root@nginx-proxy:~# service nginx restart
</span></span><span style="display:flex;"><span>Restarting nginx: nginx.
</span></span></code></pre></div><p>This whole process was fairly painless, and shockingly it worked right off the bat, no troubleshooting required. I&rsquo;m not sure if my config is 100% correct w/ regards to the reverse proxy settings at the top but everything seems to work as expected. Also as a nice side effect, nginx happens to use about 1/2 the memory that squid did, even while serving request through SSL encryption, that and the fact that it worked without any headache what so ever make me wonder why I didn&rsquo;t try this earlier. Now that I can proxy to HTTPS enabled servers I can start using Airtime again, so the <!-- raw HTML omitted -->radio page<!-- raw HTML omitted --> is working again! :D</p>

        </div>
        
        <div>
            Tags:
            
            <a href=/tags/archive>archive</a>
            
        </div>
         
        <br>
        <div>
            <a href="javascript:history.back()">
                &lt;&lt; Back</a>
                    <a href="#top">Top ^^</a>
        </div>
    </article>
</main>
 




<div id="myModal" class="modal">
    <div class="modal-content">
        <img class="modal-pic" id="modalPic" onclick="closeModal()"
            style="max-width: 100%; max-height: 80vh; margin: auto;">
    </div>
    <button class="modal-close" onclick="closeModal()">X</button>
</div>

<script>
    
    function openModal(clicked_id) {
        var src = document.getElementById(clicked_id).src;
        if (src.includes("#")) {
            src = src.substring(0, src.indexOf("#"));
        };
        document.getElementById("modalPic").src = src;
        document.getElementById("myModal").style.display = "block";
        
        
        document.getElementById("site-header").style.display = "none";
        document.getElementById("content").style.display = "none";
        document.getElementById("site-footer").style.display = "none";
    }

    
    function closeModal() {
        
        document.getElementById("modalPic").src = "";
        document.getElementById("myModal").style.display = "none";
        
        document.getElementById("site-header").style.display = "block";
        document.getElementById("content").style.display = "block";
        document.getElementById("site-footer").style.display = "block";
    }
    closeModal()
</script>    

<footer id="site-footer">
    <p>
        &copy; 2024 <a href="https://mikeder.net/">mikeder.net</a> v:6cc2fda</p>

    
    <a class="fab fa-bandcamp" style="font-size: 24px" href="https://bandcamp.com/mikeder" target="_blank"></a>
     
    <a class="fab fa-docker" style="font-size: 24px" href="https://hub.docker.com/u/mikeder" target="_blank"></a>
     
    <a class="fab fa-github" rel="me" style="font-size: 24px" href="https://github.com/mikeder" target="_blank"></a>
     
    <a class="fab fa-instagram" style="font-size: 24px" href="https://www.instagram.com/sqweebking/" target="_blank"></a>
     
    <a class="fab fa-mastodon" style="font-size: 24px" href="https://universeodon.com/@sqweebking" target="_blank"></a>
     
    <a class="fab fa-soundcloud" style="font-size: 24px" href="https://soundcloud.com/sqweebking" target="_blank"></a>
     
    <a class="fab fa-youtube" style="font-size: 24px" href="https://www.youtube.com/user/synthatik" target="_blank"></a>
    
</footer>
</body>

</html>